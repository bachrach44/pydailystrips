import sys, getopt, time, urllib2, re

outfile = "index.html"

def GetStrip(name, data):
	#print name
	#print data
	#add in homepage later
	html = "<b>"+data.get('name')+"</b> by "+data.get('artist')+"<br /><br />\n"
	if (data['type'].startswith('search')):
		url = data.get('homepage')
		if (data.get('baseurl')):
			url = data.get('baseurl')
		request = urllib2.Request(url)
		request.add_header("User-Agent", "Python Daily Strips") 
		request.add_header("Accept", "text/html")
		resp = urllib2.urlopen(request)
		page = resp.read()
		pattern = re.compile(data.get('searchpattern'))
		#print pattern
		if (pattern.search(page)):
			html += "<img src=\""
			print "yes!"
			matches = pattern.findall(page)
			if (data.get('baseurl')):
				html += str(data.get('baseurl'))+matches[0]
			else:
				html += str(matches[0])
			html += "\" /><br /><br />\n\n"
		else:
			html += "Couldn't find regex in page<br /><br />\n"
	elif (data['type'].startswith('generate')):
		return html+"not done yet<br />\n"
	else:
		return html+"Type of comic not supported<br>\n"
	return html

def getStrips(toget, strips):
	html = 'Could not find strip in strips.def file'
	for s in toget:
		html = GetStrip(s, strips.get(s))
		with open(outfile, "a") as myfile:
			myfile.write(html)

def init():
	strips = {}
	with open("strips.def", "r") as defs:
		strip = {}
		title = ''
    		for line in defs:
			line = line.strip()
			if (not line):
				continue
			if (line.startswith('#')):
				continue
			if (line.startswith("end")):
				strips[title] = strip
				strip = {}
				title=''
				continue
			if (line.startswith("strip")):
				id, name = line.split(" ", 1)
				title = name
				#print "strip begin "+strip['name']
			elif (line.startswith("class")):
				#not handled yet
				id, call = line.split(" ", 1)
				title = call
			else:
				prop, val = line.split(" ", 1)
				strip[prop] = val
	return strips

def printFooter():
	with open(outfile, "a") as myfile:
		myfile.write("generated at "+time.asctime(time.localtime(time.time()))+"<br />\n")
		myfile.write("powered by <a href=\"https://github.com/bachrach44/pydailystrips\">py daily strips</a>\n</body></html>\n")

def printHeader():
	with open(outfile, "w") as myfile:
		myfile.write("<html><head><title>Python Daily Strips</title></head>\n<body><b>Python Daily Strips</b><br />\n\n")

def main(argv):
	#will call app with list of strips and possible opts
	#process some options (output, input)
	infile = ""
	opts, args = getopt.getopt(argv[1:],"o:",["output="])
	for opt, arg in opts:
		#print opt+" "+arg
		if opt in ("-o", "--output"):
			outfile = arg
		if opt in ("-i", "--input"):
			infile = arg
	#load classes from def file
	strips = init()
	printHeader()

	#toget = list of input strips
	if (infile):
		#load toget from infile
	else:
		#load toget from command line
	toget = ['smbc', 'test', 'evilcomic', 'dilbert']
	getStrips(toget, strips)

	printFooter()

main(sys.argv)

